{
    "$defs": {
        "actionDefinition": {
            "properties": {
                "costs": {
                    "items": { "$ref": "#/$defs/effect" },
                    "type": "array"
                },
                "description": { "type": "string" },
                "displayName": { "type": "string" },
                "effects": {
                    "items": { "$ref": "#/$defs/effect" },
                    "type": "array"
                },
                "iconUrl": { "type": "string" },
                "name": { "type": "string" },
                "preconditions": {
                    "items": { "$ref": "#/$defs/condition" },
                    "type": "array"
                },
                "targeting": {
                    "$ref": "#/$defs/targeting"
                }
            },
            "required": ["name", "effects"],
            "type": "object"
        },
        "componentDefinition": {
            "properties": {
                "properties": {
                    "additionalProperties": {
                        "$ref": "#/$defs/propertyDefinition"
                    },
                    "type": "object"
                }
            },
            "type": "object"
        },
        "condition": {
            "allOf": [
                {
                    "if": {
                        "properties": { "type": { "const": "phaseCheck" } }
                    },
                    "then": {
                        "properties": {
                            "phases": {
                                "items": { "type": "string" },
                                "type": "array"
                            }
                        },
                        "required": ["phases"]
                    }
                },
                {
                    "if": {
                        "properties": { "type": { "const": "resourceCheck" } }
                    },
                    "then": {
                        "properties": {
                            "component": { "type": "string" },
                            "entity": { "$ref": "#/$defs/entityExpression" },
                            "operator": {
                                "enum": [">=", ">", "<=", "<", "==", "!="],
                                "type": "string"
                            },
                            "property": { "type": "string" },
                            "value": { "$ref": "#/$defs/numberExpression" }
                        },
                        "required": [
                            "entity",
                            "component",
                            "property",
                            "operator",
                            "value"
                        ]
                    }
                },
                {
                    "if": { "properties": { "type": { "const": "and" } } },
                    "then": {
                        "properties": {
                            "conditions": {
                                "items": { "$ref": "#/$defs/condition" },
                                "type": "array"
                            }
                        },
                        "required": ["conditions"]
                    }
                },
                {
                    "if": { "properties": { "type": { "const": "or" } } },
                    "then": {
                        "properties": {
                            "conditions": {
                                "items": { "$ref": "#/$defs/condition" },
                                "type": "array"
                            }
                        },
                        "required": ["conditions"]
                    }
                },
                {
                    "if": { "properties": { "type": { "const": "not" } } },
                    "then": {
                        "properties": {
                            "condition": { "$ref": "#/$defs/condition" }
                        },
                        "required": ["condition"]
                    }
                }
            ],
            "properties": {
                "type": {
                    "enum": [
                        "isPlayerTurn",
                        "phaseCheck",
                        "resourceCheck",
                        "entityInZone",
                        "componentValueCheck",
                        "ownerCheck",
                        "targetCount",
                        "entityExists",
                        "zoneHasEntities",
                        "hasComponent",
                        "and",
                        "or",
                        "not"
                    ],
                    "type": "string"
                }
            },
            "required": ["type"],
            "type": "object"
        },
        "effect": {
            "allOf": [
                {
                    "if": {
                        "properties": { "type": { "const": "moveEntity" } }
                    },
                    "then": {
                        "properties": {
                            "entity": { "$ref": "#/$defs/entityExpression" },
                            "eventType": { "type": "string" },
                            "fromZone": { "$ref": "#/$defs/zoneExpression" },
                            "toZone": { "$ref": "#/$defs/zoneExpression" }
                        },
                        "required": ["entity", "toZone"]
                    }
                },
                {
                    "if": {
                        "properties": { "type": { "const": "modifyResource" } }
                    },
                    "then": {
                        "properties": {
                            "amount": { "$ref": "#/$defs/numberExpression" },
                            "component": { "type": "string" },
                            "entity": { "$ref": "#/$defs/entityExpression" },
                            "eventType": { "type": "string" },
                            "max": { "type": "number" },
                            "min": { "type": "number" },
                            "property": { "type": "string" }
                        },
                        "required": [
                            "entity",
                            "component",
                            "property",
                            "amount"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": { "const": "transferMultiple" }
                        }
                    },
                    "then": {
                        "properties": {
                            "count": { "$ref": "#/$defs/numberExpression" },
                            "eventType": { "type": "string" },
                            "filter": { "$ref": "#/$defs/condition" },
                            "fromZone": { "$ref": "#/$defs/zoneExpression" },
                            "selection": {
                                "enum": ["top", "bottom", "random"],
                                "type": "string"
                            },
                            "toZone": { "$ref": "#/$defs/zoneExpression" }
                        },
                        "required": ["fromZone", "toZone", "count"]
                    }
                },
                {
                    "if": {
                        "properties": { "type": { "const": "composite" } }
                    },
                    "then": {
                        "properties": {
                            "effects": {
                                "items": { "$ref": "#/$defs/effect" },
                                "type": "array"
                            }
                        },
                        "required": ["effects"]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": { "const": "switchActivePlayer" }
                        }
                    },
                    "then": {
                        "properties": {}
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": { "const": "checkTicTacToeWin" }
                        }
                    },
                    "then": {
                        "properties": {}
                    }
                }
            ],
            "properties": {
                "type": {
                    "enum": [
                        "moveEntity",
                        "modifyResource",
                        "setComponentValue",
                        "createEntity",
                        "destroyEntity",
                        "shuffleZone",
                        "transferMultiple",
                        "conditional",
                        "repeat",
                        "emitEvent",
                        "composite",
                        "switchActivePlayer",
                        "checkTicTacToeWin"
                    ],
                    "type": "string"
                }
            },
            "required": ["type"],
            "type": "object"
        },
        "entityExpression": {
            "description": "Expression resolving to an entity: $actor, $target, $target.0, $param.cardId, etc.",
            "pattern": "^\\$",
            "type": "string"
        },
        "entityQuery": {
            "properties": {
                "filter": { "$ref": "#/$defs/condition" },
                "hasComponent": {
                    "items": { "type": "string" },
                    "type": "array"
                },
                "owner": {
                    "enum": ["actor", "opponent", "any"],
                    "type": "string"
                },
                "zone": { "type": "string" }
            },
            "type": "object"
        },
        "entityTemplate": {
            "properties": {
                "components": {
                    "additionalProperties": {
                        "type": "object"
                    },
                    "type": "object"
                },
                "extends": { "type": "string" }
            },
            "required": ["components"],
            "type": "object"
        },
        "metadata": {
            "properties": {
                "author": { "type": "string" },
                "complexity": {
                    "enum": ["simple", "medium", "complex"],
                    "type": "string"
                },
                "description": { "type": "string" },
                "estimatedDuration": { "type": "string" },
                "maxPlayers": { "minimum": 1, "type": "integer" },
                "minPlayers": { "minimum": 1, "type": "integer" },
                "tags": { "items": { "type": "string" }, "type": "array" }
            },
            "type": "object"
        },
        "numberExpression": {
            "oneOf": [
                { "type": "number" },
                {
                    "description": "Expression resolving to a number: $param.damage, $component.$target.Card.cost, etc.",
                    "pattern": "^\\$",
                    "type": "string"
                }
            ]
        },
        "phaseDefinition": {
            "properties": {
                "allowedActions": {
                    "items": { "type": "string" },
                    "type": "array"
                },
                "autoAdvance": { "default": false, "type": "boolean" },
                "name": { "type": "string" },
                "nextPhase": {
                    "oneOf": [{ "type": "string" }, { "type": "object" }]
                },
                "onEnter": {
                    "items": { "$ref": "#/$defs/effect" },
                    "type": "array"
                },
                "onExit": {
                    "items": { "$ref": "#/$defs/effect" },
                    "type": "array"
                }
            },
            "required": ["name", "allowedActions"],
            "type": "object"
        },
        "propertyDefinition": {
            "properties": {
                "default": {},
                "description": { "type": "string" },
                "type": {
                    "enum": [
                        "string",
                        "number",
                        "boolean",
                        "entity",
                        "array",
                        "object"
                    ],
                    "type": "string"
                }
            },
            "required": ["type"],
            "type": "object"
        },
        "ruleDefinition": {
            "properties": {
                "conditions": {
                    "items": { "$ref": "#/$defs/condition" },
                    "type": "array"
                },
                "effects": {
                    "items": { "$ref": "#/$defs/effect" },
                    "type": "array"
                },
                "id": { "type": "string" },
                "priority": { "default": 100, "type": "integer" },
                "trigger": {
                    "properties": {
                        "eventType": { "type": "string" },
                        "filters": { "type": "object" }
                    },
                    "required": ["eventType"],
                    "type": "object"
                }
            },
            "required": ["id", "trigger", "effects"],
            "type": "object"
        },
        "setupDefinition": {
            "properties": {
                "initialPhase": { "type": "string" },
                "perPlayer": {
                    "properties": {
                        "startingEntities": {
                            "items": {
                                "properties": {
                                    "count": {
                                        "default": 1,
                                        "minimum": 1,
                                        "type": "integer"
                                    },
                                    "template": { "type": "string" },
                                    "zone": { "type": "string" }
                                },
                                "required": ["template", "zone"],
                                "type": "object"
                            },
                            "type": "array"
                        },
                        "template": { "type": "string" },
                        "zones": {
                            "items": { "type": "string" },
                            "type": "array"
                        }
                    },
                    "required": ["template", "zones"],
                    "type": "object"
                },
                "playerCount": {
                    "properties": {
                        "max": { "minimum": 1, "type": "integer" },
                        "min": { "minimum": 1, "type": "integer" }
                    },
                    "required": ["min", "max"],
                    "type": "object"
                },
                "setupEffects": {
                    "items": { "$ref": "#/$defs/effect" },
                    "type": "array"
                }
            },
            "required": ["playerCount", "initialPhase", "perPlayer"],
            "type": "object"
        },
        "targeting": {
            "properties": {
                "count": {
                    "oneOf": [
                        { "minimum": 0, "type": "integer" },
                        {
                            "properties": {
                                "max": { "minimum": 0, "type": "integer" },
                                "min": { "minimum": 0, "type": "integer" }
                            },
                            "type": "object"
                        }
                    ]
                },
                "types": {
                    "items": {
                        "properties": {
                            "name": { "type": "string" },
                            "query": { "$ref": "#/$defs/entityQuery" }
                        },
                        "type": "object"
                    },
                    "type": "array"
                },
                "validTargets": { "$ref": "#/$defs/entityQuery" }
            },
            "type": "object"
        },
        "winCondition": {
            "properties": {
                "condition": { "$ref": "#/$defs/condition" },
                "id": { "type": "string" },
                "message": { "type": "string" },
                "winner": {
                    "enum": ["actor", "opponent", "draw"],
                    "type": "string"
                }
            },
            "required": ["id", "condition"],
            "type": "object"
        },
        "zoneDefinition": {
            "properties": {
                "maxSize": { "minimum": 0, "type": "integer" },
                "ordered": { "default": true, "type": "boolean" },
                "visibility": {
                    "default": "public",
                    "enum": ["public", "private", "owner-only"],
                    "type": "string"
                }
            },
            "type": "object"
        },
        "zoneExpression": {
            "description": "Expression resolving to a zone: $zone.actor.hand, $zone.opponent.board, etc.",
            "pattern": "^\\$zone\\.",
            "type": "string"
        }
    },
    "$id": "https://ue-too.github.io/board-game-engine/game-definition.schema.json",
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "description": "Schema for defining board games declaratively in JSON format",
    "properties": {
        "$schema": {
            "description": "JSON Schema reference",
            "type": "string"
        },
        "actions": {
            "description": "Action definitions",
            "items": {
                "$ref": "#/$defs/actionDefinition"
            },
            "type": "array"
        },
        "components": {
            "additionalProperties": {
                "$ref": "#/$defs/componentDefinition"
            },
            "description": "Component type definitions",
            "type": "object"
        },
        "entityTemplates": {
            "additionalProperties": {
                "$ref": "#/$defs/entityTemplate"
            },
            "description": "Entity template definitions",
            "type": "object"
        },
        "metadata": {
            "$ref": "#/$defs/metadata"
        },
        "name": {
            "description": "Name of the game",
            "type": "string"
        },
        "phases": {
            "description": "Phase definitions",
            "items": {
                "$ref": "#/$defs/phaseDefinition"
            },
            "type": "array"
        },
        "rules": {
            "description": "Event-triggered rule definitions",
            "items": {
                "$ref": "#/$defs/ruleDefinition"
            },
            "type": "array"
        },
        "setup": {
            "$ref": "#/$defs/setupDefinition"
        },
        "version": {
            "description": "Version of the game definition",
            "pattern": "^\\d+\\.\\d+\\.\\d+$",
            "type": "string"
        },
        "winConditions": {
            "description": "Win/loss condition definitions",
            "items": {
                "$ref": "#/$defs/winCondition"
            },
            "type": "array"
        },
        "zones": {
            "additionalProperties": {
                "$ref": "#/$defs/zoneDefinition"
            },
            "description": "Zone definitions",
            "type": "object"
        }
    },
    "required": [
        "name",
        "version",
        "components",
        "zones",
        "entityTemplates",
        "actions",
        "phases",
        "setup"
    ],
    "title": "Board Game Definition",
    "type": "object"
}
