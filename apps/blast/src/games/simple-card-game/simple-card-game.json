{
    "$schema": "../../board-game-engine/schema/json-schema/game-definition.schema.json",
    "actions": [
        {
            "description": "Draw the top card from your deck",
            "displayName": "Draw Card",
            "effects": [
                {
                    "count": 1,
                    "eventType": "CardDrawn",
                    "fromZone": "$zone.actor.deck",
                    "selection": "top",
                    "toZone": "$zone.actor.hand",
                    "type": "transferMultiple"
                },
                {
                    "component": "TurnState",
                    "entity": "$actor",
                    "property": "hasDrawnThisTurn",
                    "type": "setComponentValue",
                    "value": true
                }
            ],
            "name": "DrawCard",
            "preconditions": [
                { "type": "isPlayerTurn" },
                { "phases": ["Main"], "type": "phaseCheck" },
                {
                    "component": "TurnState",
                    "entity": "$actor",
                    "errorMessage": "You have already drawn a card this turn",
                    "property": "hasDrawnThisTurn",
                    "type": "componentValueCheck",
                    "value": false
                },
                {
                    "errorMessage": "Your deck is empty",
                    "minCount": 1,
                    "type": "zoneHasEntities",
                    "zone": "$zone.actor.deck"
                }
            ],
            "targeting": {
                "count": 0
            }
        },
        {
            "costs": [
                {
                    "amount": "$negate($component.$target.Card.cost)",
                    "component": "Resource",
                    "entity": "$actor",
                    "property": "mana",
                    "type": "modifyResource"
                }
            ],
            "description": "Play a card from your hand to the board",
            "displayName": "Play Card",
            "effects": [
                {
                    "entity": "$target",
                    "eventType": "CardPlayed",
                    "fromZone": "$zone.actor.hand",
                    "toZone": "$zone.actor.board",
                    "type": "moveEntity"
                },
                {
                    "condition": {
                        "component": "Card",
                        "entity": "$target",
                        "property": "cardType",
                        "type": "componentValueCheck",
                        "value": "Creature"
                    },
                    "then": [
                        {
                            "component": "CardState",
                            "createIfMissing": true,
                            "entity": "$target",
                            "type": "setComponentValue",
                            "values": {
                                "attacksThisTurn": 0,
                                "summoningSickness": true,
                                "tapped": false
                            }
                        }
                    ],
                    "type": "conditional"
                }
            ],
            "name": "PlayCard",
            "preconditions": [
                { "type": "isPlayerTurn" },
                { "phases": ["Main"], "type": "phaseCheck" },
                {
                    "component": "Card",
                    "entity": "$target",
                    "errorMessage": "Target must be a card",
                    "type": "hasComponent"
                },
                {
                    "entity": "$target",
                    "errorMessage": "Card must be in your hand",
                    "type": "entityInZone",
                    "zone": "$zone.actor.hand"
                },
                {
                    "entity": "$target",
                    "errorMessage": "You must own the card",
                    "expectedOwner": "$actor",
                    "type": "ownerCheck"
                },
                {
                    "component": "Resource",
                    "entity": "$actor",
                    "errorMessage": "Not enough mana",
                    "operator": ">=",
                    "property": "mana",
                    "type": "resourceCheck",
                    "value": "$component.$target.Card.cost"
                }
            ],
            "targeting": {
                "count": 1,
                "validTargets": {
                    "hasComponent": ["Card"],
                    "owner": "actor",
                    "zone": "hand"
                }
            }
        },
        {
            "description": "Attack an enemy creature with one of your creatures. Targets: [0] Your creature, [1] Enemy creature",
            "displayName": "Attack Creature",
            "effects": [
                {
                    "component": "CardState",
                    "createIfMissing": true,
                    "entity": "$target.0",
                    "property": "tapped",
                    "type": "setComponentValue",
                    "value": true
                },
                {
                    "component": "CardState",
                    "createIfMissing": true,
                    "entity": "$target.0",
                    "property": "attacksThisTurn",
                    "type": "setComponentValue",
                    "value": 1
                },
                {
                    "amount": "$negate($component.$target.0.Card.power)",
                    "component": "Card",
                    "entity": "$target.1",
                    "min": 0,
                    "property": "toughness",
                    "type": "modifyResource"
                },
                {
                    "amount": "$negate($component.$target.1.Card.power)",
                    "component": "Card",
                    "entity": "$target.0",
                    "min": 0,
                    "property": "toughness",
                    "type": "modifyResource"
                },
                {
                    "condition": {
                        "component": "Card",
                        "entity": "$target.1",
                        "operator": "<=",
                        "property": "toughness",
                        "type": "componentValueCheck",
                        "value": 0
                    },
                    "then": [
                        {
                            "entity": "$target.1",
                            "toZone": "$zone.opponent.discard",
                            "type": "moveEntity"
                        }
                    ],
                    "type": "conditional"
                },
                {
                    "condition": {
                        "component": "Card",
                        "entity": "$target.0",
                        "operator": "<=",
                        "property": "toughness",
                        "type": "componentValueCheck",
                        "value": 0
                    },
                    "then": [
                        {
                            "entity": "$target.0",
                            "toZone": "$zone.actor.discard",
                            "type": "moveEntity"
                        }
                    ],
                    "type": "conditional"
                },
                {
                    "data": {
                        "attackerId": "$target.0",
                        "defenderId": "$target.1"
                    },
                    "eventType": "CreatureAttacked",
                    "type": "emitEvent"
                }
            ],
            "name": "AttackCreature",
            "preconditions": [
                { "type": "isPlayerTurn" },
                { "phases": ["Main"], "type": "phaseCheck" },
                {
                    "errorMessage": "Must select attacker and defender",
                    "exact": 2,
                    "type": "targetCount"
                },
                {
                    "component": "Card",
                    "entity": "$target.0",
                    "errorMessage": "Attacker must be a card",
                    "type": "hasComponent"
                },
                {
                    "component": "Card",
                    "entity": "$target.0",
                    "errorMessage": "Attacker must be a creature",
                    "property": "cardType",
                    "type": "componentValueCheck",
                    "value": "Creature"
                },
                {
                    "entity": "$target.0",
                    "errorMessage": "Attacker must be on your board",
                    "type": "entityInZone",
                    "zone": "$zone.actor.board"
                },
                {
                    "entity": "$target.0",
                    "errorMessage": "You must own the attacker",
                    "expectedOwner": "$actor",
                    "type": "ownerCheck"
                },
                {
                    "component": "Card",
                    "entity": "$target.1",
                    "errorMessage": "Defender must be a card",
                    "type": "hasComponent"
                },
                {
                    "component": "Card",
                    "entity": "$target.1",
                    "errorMessage": "Defender must be a creature",
                    "property": "cardType",
                    "type": "componentValueCheck",
                    "value": "Creature"
                },
                {
                    "entity": "$target.1",
                    "errorMessage": "Defender must be an enemy creature",
                    "expectedOwner": "$actor",
                    "invert": true,
                    "type": "ownerCheck"
                }
            ],
            "targeting": {
                "count": 2,
                "validTargets": {
                    "hasComponent": ["Card"],
                    "owner": "any",
                    "zone": "board"
                }
            }
        },
        {
            "description": "End your turn and pass to the next player",
            "displayName": "End Turn",
            "effects": [
                {
                    "data": {
                        "playerId": "$actor"
                    },
                    "eventType": "TurnEnded",
                    "type": "emitEvent"
                }
            ],
            "name": "EndTurn",
            "preconditions": [{ "type": "isPlayerTurn" }],
            "targeting": {
                "count": 0
            }
        }
    ],

    "components": {
        "Card": {
            "properties": {
                "cardType": { "type": "string" },
                "cost": { "type": "number" },
                "description": { "type": "string" },
                "effectId": { "type": "string" },
                "name": { "type": "string" },
                "power": { "type": "number" },
                "toughness": { "type": "number" }
            }
        },
        "CardState": {
            "properties": {
                "attacksThisTurn": { "default": 0, "type": "number" },
                "summoningSickness": { "default": false, "type": "boolean" },
                "tapped": { "default": false, "type": "boolean" }
            }
        },
        "Location": {
            "properties": {
                "location": { "type": "entity" },
                "sortIndex": { "default": 0, "type": "number" }
            }
        },
        "Owner": {
            "properties": {
                "owner": { "type": "entity" }
            }
        },
        "Resource": {
            "properties": {
                "health": { "default": 20, "type": "number" },
                "mana": { "default": 1, "type": "number" },
                "maxHealth": { "default": 20, "type": "number" },
                "maxMana": { "default": 10, "type": "number" }
            }
        },
        "TurnState": {
            "properties": {
                "hasDrawnThisTurn": { "default": false, "type": "boolean" }
            }
        }
    },

    "entityTemplates": {
        "DragonWhelp": {
            "components": {
                "Card": {
                    "cardType": "Creature",
                    "cost": 5,
                    "description": "A young but fierce dragon.",
                    "name": "Dragon Whelp",
                    "power": 5,
                    "toughness": 3
                },
                "Owner": {
                    "owner": "$param.owner"
                }
            }
        },
        "FireElemental": {
            "components": {
                "Card": {
                    "cardType": "Creature",
                    "cost": 3,
                    "description": "Burns with inner flame.",
                    "name": "Fire Elemental",
                    "power": 3,
                    "toughness": 2
                },
                "Owner": {
                    "owner": "$param.owner"
                }
            }
        },
        "ForestSprite": {
            "components": {
                "Card": {
                    "cardType": "Creature",
                    "cost": 1,
                    "description": "A tiny forest dweller.",
                    "name": "Forest Sprite",
                    "power": 1,
                    "toughness": 2
                },
                "Owner": {
                    "owner": "$param.owner"
                }
            }
        },
        "GoblinScout": {
            "components": {
                "Card": {
                    "cardType": "Creature",
                    "cost": 1,
                    "description": "A quick goblin.",
                    "name": "Goblin Scout",
                    "power": 1,
                    "toughness": 1
                },
                "Owner": {
                    "owner": "$param.owner"
                }
            }
        },
        "IronGolem": {
            "components": {
                "Card": {
                    "cardType": "Creature",
                    "cost": 2,
                    "description": "A sturdy construct.",
                    "name": "Iron Golem",
                    "power": 2,
                    "toughness": 2
                },
                "Owner": {
                    "owner": "$param.owner"
                }
            }
        },
        "Player": {
            "components": {
                "Player": {
                    "name": "$param.playerName",
                    "playerNumber": "$param.playerIndex"
                },
                "Resource": {
                    "health": 20,
                    "mana": 1,
                    "maxHealth": 20,
                    "maxMana": 10
                },
                "TurnState": {
                    "hasDrawnThisTurn": false
                }
            }
        },
        "StoneGiant": {
            "components": {
                "Card": {
                    "cardType": "Creature",
                    "cost": 4,
                    "description": "A massive stone creature.",
                    "name": "Stone Giant",
                    "power": 4,
                    "toughness": 4
                },
                "Owner": {
                    "owner": "$param.owner"
                }
            }
        }
    },

    "metadata": {
        "author": "ue-too",
        "complexity": "simple",
        "description": "A simple 2-player card game with creatures, mana, and combat",
        "maxPlayers": 2,
        "minPlayers": 2,
        "tags": ["card-game", "creatures", "mana"]
    },

    "name": "Simple Card Game",
    "phases": [
        {
            "allowedActions": [
                "DrawCard",
                "PlayCard",
                "AttackCreature",
                "AttackPlayer",
                "ActivateAbility",
                "EndTurn"
            ],
            "autoAdvance": false,
            "name": "Main",
            "nextPhase": "Main",
            "onEnter": [
                {
                    "amount": 1,
                    "component": "Resource",
                    "entity": "$activePlayer",
                    "maxProperty": "maxMana",
                    "property": "mana",
                    "type": "modifyResource"
                }
            ]
        }
    ],

    "rules": [
        {
            "effects": [
                {
                    "type": "switchActivePlayer"
                }
            ],
            "id": "switchPlayerOnTurnEnded",
            "priority": 100,
            "trigger": {
                "eventType": "TurnEnded"
            }
        },
        {
            "effects": [
                {
                    "amount": 1,
                    "component": "Resource",
                    "entity": "$param.playerId",
                    "maxProperty": "maxMana",
                    "property": "mana",
                    "type": "modifyResource"
                }
            ],
            "id": "giveManaOnTurnEnd",
            "priority": 90,
            "trigger": {
                "eventType": "TurnEnded"
            }
        },
        {
            "effects": [
                {
                    "component": "TurnState",
                    "createIfMissing": true,
                    "entity": "$param.newPlayerId",
                    "property": "hasDrawnThisTurn",
                    "type": "setComponentValue",
                    "value": false
                }
            ],
            "id": "resetTurnStateOnPlayerChange",
            "priority": 100,
            "trigger": {
                "eventType": "ActivePlayerChanged"
            }
        }
    ],

    "setup": {
        "initialPhase": "Main",
        "perPlayer": {
            "startingEntities": [
                { "count": 2, "template": "GoblinScout", "zone": "deck" },
                { "count": 2, "template": "ForestSprite", "zone": "deck" },
                { "count": 2, "template": "IronGolem", "zone": "deck" },
                { "count": 2, "template": "FireElemental", "zone": "deck" },
                { "count": 1, "template": "StoneGiant", "zone": "deck" },
                { "count": 1, "template": "DragonWhelp", "zone": "deck" }
            ],
            "template": "Player",
            "zones": ["deck", "hand", "board", "discard"]
        },
        "playerCount": {
            "max": 2,
            "min": 2
        },
        "setupEffects": [
            {
                "type": "shuffleZone",
                "zone": "$zone.$eachPlayer.deck"
            },
            {
                "count": 3,
                "fromZone": "$zone.$eachPlayer.deck",
                "selection": "top",
                "toZone": "$zone.$eachPlayer.hand",
                "type": "transferMultiple"
            }
        ]
    },

    "version": "1.0.0",
    "winConditions": [
        {
            "condition": {
                "component": "Resource",
                "entity": "$opponent",
                "operator": "<=",
                "property": "health",
                "type": "resourceCheck",
                "value": 0
            },
            "id": "player-eliminated",
            "message": "Opponent's health reduced to zero!",
            "winner": "actor"
        }
    ],
    "zones": {
        "board": {
            "ordered": false,
            "visibility": "public"
        },
        "deck": {
            "ordered": true,
            "visibility": "owner-only"
        },
        "discard": {
            "ordered": true,
            "visibility": "public"
        },
        "hand": {
            "ordered": true,
            "visibility": "owner-only"
        }
    }
}
